<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Wheel Toolkit v2.3.1</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Icons -->
  <!-- Hosted (online): works on localhost & static hosts when online -->
  <link rel="icon" type="image/png" href="https://drive.google.com/uc?export=view&id=1HNnjMz0RhrmQEt_cWE3jhITvvjmo1meS">
  <link rel="apple-touch-icon" href="https://drive.google.com/uc?export=view&id=1HNnjMz0RhrmQEt_cWE3jhITvvjmo1meS">

  <style>
    :root{
      --bg:#f5f5f7; --card:#fff; --text:#1d1d1f; --muted:#6e6e73; --blue:#007aff;
      --shadow:0 10px 30px rgba(0,0,0,.08); --radius:20px; --line:#e5e5ea;
    }
    body.dark{ --bg:#1c1c1e; --card:#2c2c2e; --text:#f5f5f7; --muted:#a1a1a6; --blue:#0a84ff; --line:#3a3a3c; --shadow:0 10px 30px rgba(0,0,0,.5); }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,system-ui,sans-serif; background:var(--bg); color:var(--text); }
    header{ padding:18px 16px 8px; display:flex; align-items:center; gap:12px; justify-content:space-between; }
    .brand{ display:flex; align-items:center; gap:12px; }
    h1{ margin:0; font-size:20px; font-weight:800; letter-spacing:.2px; }
    .btn{ border:0; border-radius:12px; padding:10px 14px; background:var(--blue); color:#fff; font-weight:700; cursor:pointer; }
    .btn.ghost{ background:transparent; color:var(--text); border:1px solid var(--line); }
    .btn.mini{ padding:6px 10px; border-radius:10px; font-size:12px; }
    .toolbar{ display:flex; gap:8px; align-items:center }
    .app{ display:grid; grid-template-columns: 220px 1fr; max-width:1200px; margin:0 auto; gap:16px; padding:0 12px 24px; }
    .sidebar{ position:sticky; top:8px; align-self:start; display:flex; flex-direction:column; gap:8px; padding:8px 0 16px; }
    .tab{ border:0; border-radius:12px; padding:12px 14px; background:var(--card); color:var(--text); box-shadow:var(--shadow); font-weight:800; text-align:left; cursor:pointer; }
    .tab.active{ outline:2px solid var(--blue); }
    .page{ background:transparent; }
    .section{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; margin-bottom:16px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    input[type="text"], input[type="number"], input[type="date"], input[type="url"], select {
      padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:transparent; color:var(--text);
    }
    label{ font-size:12px; font-weight:700; color:var(--muted); display:flex; gap:6px; align-items:center }

    /* Better select & option readability in both themes */
    select { background: var(--card); color: var(--text); border:1px solid var(--line); }
    select option { background: var(--card); color: var(--text); }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{ padding:8px 10px; border-radius:999px; background:var(--card); box-shadow:var(--shadow); border:1px solid var(--line); font-weight:700; cursor:pointer; color:var(--text); }
    .grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); gap:12px; }
    .card{ background:var(--card); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); }
    .card h3, .pill { color: var(--text); }
    .muted{ color:var(--muted); }
    canvas{ width:100%; height:160px; display:block; }
    .split{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 900px){ .app{ grid-template-columns: 1fr } .split{ grid-template-columns:1fr } }
    .kpi{ display:flex; gap:12px; flex-wrap:wrap; }
    .kpi .pill{ padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:transparent; font-weight:800; }
    .right{ margin-left:auto }
    .help-modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:20px; }
    .help-content{ background:var(--card); color:var(--text); border-radius:20px; max-width:780px; width:100%; padding:20px; box-shadow:var(--shadow); }
    .linkbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .badge{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
    .sticky-head{ position:sticky; top:0; z-index:5; background:var(--bg); padding-bottom:6px; margin:-18px -18px 12px; padding:12px 18px; border-bottom:1px solid var(--line); border-top-left-radius:var(--radius); border-top-right-radius:var(--radius); }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <button id="darkToggle" class="btn ghost">üåô/‚òÄÔ∏è</button>
      <h1 id="modeTitle" title="Click to toggle name only (logic later)">Quick CSP Calculator</h1>
    </div>
    <div class="toolbar">
      <button id="helpBtn" class="btn ghost">‚ùì Help</button>
      <button id="exportBtn" class="btn ghost">Export JSON</button>
      <button id="importBtn" class="btn">Import JSON</button>
    </div>
  </header>

  <main class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <button class="tab active" data-tab="watchlist">Watchlist</button>
      <button class="tab" data-tab="calculator">Calculator</button>
      <button class="tab" data-tab="screener">Screener</button>
      <button class="tab" data-tab="journal">Journal</button>
      <button class="tab" data-tab="settings">Settings</button>
    </aside>

    <!-- Pages -->
    <section class="page">

      <!-- WATCHLIST -->
      <div id="page-watchlist" class="section">
        <div class="sticky-head">
          <div class="row">
            <h2 style="margin:0">Watchlist</h2>
            <span class="badge">Local-first</span>
            <div class="right row">
              <label>Sort
                <select id="wlSort">
                  <option value="alpha">Ticker (A‚ÜíZ)</option>
                  <option value="price">Price</option>
                </select>
              </label>
              <label>Min IV% <input id="wlMinIV" type="number" value="0" style="width:90px"></label>
            </div>
          </div>
        </div>

        <div class="row" style="margin-bottom:10px">
          <input id="addTicker" type="text" placeholder="Add ticker (e.g., RIOT)" />
          <button id="addBtn" class="btn">Add</button>
          <button id="fetchBtn" class="btn ghost">Fetch (Price & RV)</button>
          <button id="debugBridgeBtn" class="btn ghost">Debug Bridge</button>
        </div>

        <div id="wlChips" class="chips"></div>
        <div id="wlGrid" class="grid" style="margin-top:12px"></div>
      </div>

      <!-- CALCULATOR -->
      <div id="page-calculator" class="section" style="display:none">
        <div class="row">
          <input id="calcTicker" type="text" placeholder="Ticker" style="width:120px">
          <label>Strike $ <input id="calcStrike" type="number" step="0.01" style="width:120px"></label>
          <label>Premium $ <input id="calcPremium" type="number" step="0.01" style="width:120px"></label>
          <label>Contracts <input id="calcContracts" type="number" value="1" style="width:100px"></label>
          <label>Expiration <input id="calcExpiry" type="date" style="width:170px"></label>
        </div>

        <div class="row" style="margin-top:8px">
          <label>Manual IV % (optional) <input id="calcManualIV" type="number" step="0.01" placeholder="e.g., 75" style="width:110px"></label>
          <span id="rvLabel" class="badge">RV20: ‚Äî</span>
          <label>Fees $ <input id="calcFees" type="number" step="0.01" value="0.65" style="width:90px"></label>
          <label>Slippage % <input id="calcSlip" type="number" step="0.01" value="0.00" style="width:90px"></label>
          <button id="calcBtn" class="btn">Calculate</button>
          <button id="saveCspBtn" class="btn ghost">Save CSP Leg</button>
        </div>

        <div class="split" style="margin-top:14px">
          <div class="card">
            <h3 style="margin-top:0;margin-bottom:6px">Results</h3>
            <div class="kpi" id="calcKPIs">
              <div class="pill" id="kpiPrice">Price: ‚Äî</div>
              <div class="pill" id="kpiBreakeven">BE: ‚Äî</div>
              <div class="pill" id="kpiYield">Monthly %: ‚Äî</div>
              <div class="pill" id="kpiPoP">PoP: ‚Äî</div>
              <div class="pill" id="kpiCollateral">Collateral: ‚Äî</div>
            </div>
            <div style="margin-top:10px" class="linkbar">
              <button id="lkRobin" class="btn mini ghost">Robinhood Chain</button>
              <button id="lkAlpha" class="btn mini ghost">AlphaSpread</button>
              <button id="lkYahoo" class="btn mini ghost">Yahoo Options</button>
            </div>
            <div class="muted" style="font-size:11px;margin-top:6px">Tip: on Yahoo Options, press ‚Äú/‚Äù then type your strike to jump.</div>
          </div>
          <div class="card">
            <h3 style="margin-top:0;margin-bottom:6px">Price & Strike</h3>
            <canvas id="calcChart" width="600" height="160"></canvas>
            <div class="muted" style="font-size:12px;margin-top:6px">Timeline uses last ~1y daily closes from your Bridge. Lines show current price, strike, and break-even.</div>
          </div>
        </div>
      </div>

      <!-- SCREENER -->
      <div id="page-screener" class="section" style="display:none">
        <div class="row">
          <label>Min PoP % <input id="scMinPop" type="number" value="77" style="width:90px"></label>
          <label>Min Monthly % <input id="scMinYield" type="number" value="1.0" style="width:100px"></label>
          <label>DTE ‚â§ <input id="scMaxDte" type="number" value="45" style="width:80px"></label>
          <label>Sort
            <select id="scSort">
              <option value="default">Default</option>
              <option value="yieldAsc">Monthly % ‚Üë</option>
              <option value="yieldDesc">Monthly % ‚Üì</option>
              <option value="evAsc">EV/$ ‚Üë (spreads later)</option>
              <option value="evDesc">EV/$ ‚Üì (spreads later)</option>
            </select>
          </label>
          <button id="scRun" class="btn">Scan</button>
        </div>
        <div id="scGrid" class="grid" style="margin-top:12px"></div>
      </div>

      <!-- JOURNAL -->
      <div id="page-journal" class="section" style="display:none">
        <div class="row">
          <h2 style="margin:0">Journal</h2>
          <div class="right kpi">
            <div class="pill" id="jrCspWin">CSP Winrate: ‚Äî</div>
            <div class="pill" id="jrAssignRate">Assignment: ‚Äî</div>
            <div class="pill" id="jrCyclePnl">Closed Cycle PnL: ‚Äî</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="addCspManual" class="btn ghost">Add CSP (manual)</button>
          <button id="addCcManual" class="btn ghost">Add CC (manual)</button>
        </div>

        <div id="journalGrid" class="grid" style="margin-top:12px"></div>
      </div>

      <!-- SETTINGS -->
      <div id="page-settings" class="section" style="display:none">
        <h2 style="margin-top:0">Settings</h2>
        <div class="row">
          <label>Bridge URL
            <input id="bridgeUrl" type="url" placeholder="https://script.google.com/macros/s/.../exec" style="min-width:420px">
          </label>
          <button id="setDefaultBridge" class="btn ghost">Default Link</button>
          <span class="muted" style="font-size:12px">This should return JSON with { current, low30d, low52w, series }.</span>
        </div>
        <div class="row" style="margin-top:8px">
          <label>Mode
            <select id="execMode">
              <option value="custom">Custom</option>
              <option value="robinhood">Robinhood (fees $0.04, slip 0%)</option>
            </select>
          </label>
          <label>Default Fees $ <input id="defFees" type="number" step="0.01" value="0.65"></label>
          <label>Default Slippage % <input id="defSlip" type="number" step="0.01" value="0.00"></label>
          <button id="saveSettings" class="btn">Save</button>
        </div>
      </div>

    </section>
  </main>

  <!-- HELP -->
  <div id="helpModal" class="help-modal" role="dialog" aria-modal="true">
    <div class="help-content">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">How to use this site</h3>
        <button id="helpClose" class="btn mini ghost">Close</button>
      </div>
      <ol>
        <li><b>Settings ‚Üí Bridge URL:</b> paste your Apps Script Web App link (should return <code>{ current, low30d, low52w, series }</code>). The default button fills yours.</li>
        <li><b>Watchlist:</b> add tickers (Enter works), then press <b>Fetch</b> to pull current price and compute RV20 from <i>series</i>. Sort/filter as you like. Click a ticker to open it in the calculator.</li>
        <li><b>Calculator:</b> enter strike, premium, and contracts. <b>Manual IV%</b> is optional ‚Äî if filled, it overrides RV20. Expiration auto-fills to the upcoming Friday (edit if needed). Use Robinhood, AlphaSpread, and Yahoo Options (puts) quick links.</li>
        <li><b>Screener:</b> set Min PoP%, Min Monthly %, and DTE window; run a scan across your watchlist. (EV for spreads is slated for a later ‚ÄúLevel 2‚Äù version.)</li>
        <li><b>Journal (Wheel-aware):</b> Save CSP legs and mark outcomes:
          <ul>
            <li><i>Non-Assignment</i> ‚Üí counts toward CSP Winrate.</li>
            <li><i>Assigned</i> ‚Üí starts a Wheel cycle; add CC legs; mark ‚ÄúCalled Away‚Äù to close the cycle and compute PnL.</li>
          </ul>
        </li>
        <li><b>Export/Import:</b> Use the top-right buttons to back up or restore all your data.</li>
      </ol>
      <p class="muted">Tip: the page is local-first ‚Äî your data stays in your browser storage until you export it.</p>
    </div>
  </div>

  <script>
  // ------------------ Config ------------------
  const DEFAULT_BRIDGE = "https://script.google.com/macros/s/AKfycbzbHte91FRBflp5xJV0vc7jAhQv0xF-tg3fwzKIUXoTu2O1mdGJL5VrfGA__kTB700Bbw/exec";

  // ------------------ State ------------------
  const state = {
    settings: {
      bridgeUrl: "",
      fees: 0.65,
      slip: 0.00,
      mode: "custom"
    },
    watch: {},            // ticker -> { current, rv20, last, seriesLen }
    tickers: [],          // order
    journal: { trades: [], cycles: [] }, // wheel-aware
    ui: { tab: "watchlist" }
  };
  const els = {};

  // ------------------ Utils ------------------
  const fmt = n => isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:2}) : "‚Äî";
  function saveAll(){ localStorage.setItem("csp_v231", JSON.stringify(state)); }
  function loadAll(){
    try{
      const s = JSON.parse(localStorage.getItem("csp_v231")||"{}");
      if(s.settings) state.settings = Object.assign(state.settings, s.settings);
      if(Array.isArray(s.tickers)) state.tickers = s.tickers;
      if(s.watch) state.watch = s.watch;
      if(s.journal) state.journal = s.journal;
    }catch{}
  }
  function nextFridayISO(){
    const d = new Date(); const day = d.getDay();
    const add = (5 - day + 7) % 7 || 7; // always future Friday
    d.setDate(d.getDate() + add);
    d.setHours(0,0,0,0);
    return d.toISOString().slice(0,10);
  }
  function normCdf(x){
    const a1=.319381530,a2=-.356563782,a3=1.781477937,a4=-1.821255978,a5=1.330274429;
    const L=Math.abs(x),k=1/(1+0.2316419*L),phi=Math.exp(-.5*L*L)/Math.sqrt(2*Math.PI);
    let c=1-phi*(a1*k+a2*k*k+a3*k**3+a4*k**4+a5*k**5); return x<0?1-c:c;
  }
  function popPut(S,K,sigma,T,r=0){
    if(!(S>0&&K>0&&sigma>0&&T>0)) return null;
    const vs=sigma*Math.sqrt(T), d2=(Math.log(S/K)+(r-0.5*sigma*sigma)*T)/vs;
    return 100*(1 - normCdf(-d2));
  }
  function realizedVolFromSeries(series, n=20){
    if(!Array.isArray(series)||series.length< n+2) return null;
    let sum=0, cnt=0;
    for(let i=1;i<series.length;i++){
      const p0=series[i-1][1], p1=series[i][1];
      if(!(p0>0&&p1>0)) continue;
      const r = Math.log(p1/p0);
      sum += r*r; cnt++;
    }
    const varD = sum/Math.max(1,cnt);
    const sdD  = Math.sqrt(varD);
    const ann  = sdD * Math.sqrt(252);
    return ann;
  }

  async function bridgePriceSeries(sym){
    const base = (state.settings.bridgeUrl||"").trim();
    if(!base) throw new Error("Set Settings ‚Üí Bridge URL");
    const url = `${base}?ticker=${encodeURIComponent(sym)}`;
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error("Bridge HTTP "+r.status);
    return await r.json(); // { current, low30d, low52w, series }
  }

  // ------------------ DOM refs ------------------
  function refs(){
    els.tabs = Array.from(document.querySelectorAll(".tab"));
    els.pages = {
      watchlist: document.getElementById("page-watchlist"),
      calculator: document.getElementById("page-calculator"),
      screener: document.getElementById("page-screener"),
      journal: document.getElementById("page-journal"),
      settings: document.getElementById("page-settings"),
    };
    // watchlist
    els.addTicker = document.getElementById("addTicker");
    els.addBtn = document.getElementById("addBtn");
    els.fetchBtn = document.getElementById("fetchBtn");
    els.wlGrid = document.getElementById("wlGrid");
    els.wlChips = document.getElementById("wlChips");
    els.wlSort = document.getElementById("wlSort");
    els.wlMinIV = document.getElementById("wlMinIV");
    // calculator
    els.calcTicker = document.getElementById("calcTicker");
    els.calcStrike = document.getElementById("calcStrike");
    els.calcPremium = document.getElementById("calcPremium");
    els.calcContracts = document.getElementById("calcContracts");
    els.calcExpiry = document.getElementById("calcExpiry");
    els.calcManualIV = document.getElementById("calcManualIV");
    els.calcFees = document.getElementById("calcFees");
    els.calcSlip = document.getElementById("calcSlip");
    els.calcBtn = document.getElementById("calcBtn");
    els.saveCspBtn = document.getElementById("saveCspBtn");
    els.rvLabel = document.getElementById("rvLabel");
    els.kpiPrice = document.getElementById("kpiPrice");
    els.kpiBreakeven = document.getElementById("kpiBreakeven");
    els.kpiYield = document.getElementById("kpiYield");
    els.kpiPoP = document.getElementById("kpiPoP");
    els.kpiCollateral = document.getElementById("kpiCollateral");
    els.lkRobin = document.getElementById("lkRobin");
    els.lkAlpha = document.getElementById("lkAlpha");
    els.lkYahoo = document.getElementById("lkYahoo");
    els.calcChart = document.getElementById("calcChart");
    // screener
    els.scMinPop = document.getElementById("scMinPop");
    els.scMinYield = document.getElementById("scMinYield");
    els.scMaxDte = document.getElementById("scMaxDte");
    els.scSort = document.getElementById("scSort");
    els.scGrid = document.getElementById("scGrid");
    els.scRun = document.getElementById("scRun");
    // journal
    els.journalGrid = document.getElementById("journalGrid");
    els.jrCspWin = document.getElementById("jrCspWin");
    els.jrAssignRate = document.getElementById("jrAssignRate");
    els.jrCyclePnl = document.getElementById("jrCyclePnl");
    els.addCspManual = document.getElementById("addCspManual");
    els.addCcManual = document.getElementById("addCcManual");
    // settings
    els.bridgeUrl = document.getElementById("bridgeUrl");
    els.setDefaultBridge = document.getElementById("setDefaultBridge");
    els.execMode = document.getElementById("execMode");
    els.defFees = document.getElementById("defFees");
    els.defSlip = document.getElementById("defSlip");
    els.saveSettings = document.getElementById("saveSettings");
    // header + help + export/import
    els.darkToggle = document.getElementById("darkToggle");
    els.modeTitle = document.getElementById("modeTitle");
    els.helpBtn = document.getElementById("helpBtn");
    els.helpModal = document.getElementById("helpModal");
    els.helpClose = document.getElementById("helpClose");
    els.exportBtn = document.getElementById("exportBtn");
    els.importBtn = document.getElementById("importBtn");
    els.calcExpiry.value = nextFridayISO();
  }

  // ------------------ UI / Tabs ------------------
  function showTab(name){
    state.ui.tab = name; saveAll();
    for(const t of els.tabs){ t.classList.toggle("active", t.dataset.tab===name); }
    Object.entries(els.pages).forEach(([k,el])=>{ el.style.display = (k===name)?"block":"none"; });
  }

  // ------------------ Watchlist ------------------
  function renderWatchlist(){
    // chips
    els.wlChips.innerHTML = "";
    state.tickers.forEach(t=>{
      const c = document.createElement("button");
      c.className = "chip";
      const meta = state.watch[t]||{};
      c.textContent = t + (meta.current? ` ‚Ä¢ $${fmt(meta.current)}`: "");
      c.onclick = ()=>{ els.calcTicker.value = t; showTab("calculator"); updateQuickLinks(); };
      els.wlChips.appendChild(c);
    });

    // cards
    const sortBy = els.wlSort.value;
    const minIV = +els.wlMinIV.value || 0;
    const items = state.tickers.slice().map(t=>{
      const m = state.watch[t]||{};
      return { t, current:m.current, rv20:m.rv20, last:m.last, seriesLen:m.seriesLen };
    });
    items.sort((a,b)=>{
      if(sortBy==="price") return (b.current||0)-(a.current||0);
      return a.t.localeCompare(b.t);
    });

    els.wlGrid.innerHTML = "";
    items.forEach(it=>{
      const estIVp = it.rv20 ? (it.rv20*100) : null;
      if(estIVp!=null && estIVp < minIV) return;
      const card = document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">${it.t}</h3>
          <span class="badge">${it.last? new Date(it.last).toLocaleString(): ""}</span>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="pill">Price: $${fmt(it.current)}</div>
          <div class="pill">RV20: ${it.rv20? fmt(it.rv20): "‚Äî"}</div>
          <div class="pill">Series: ${it.seriesLen||0}</div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn mini" data-jump="${it.t}">Open in Calculator</button>
        </div>
      `;
      card.querySelector('[data-jump]').onclick = ()=>{
        els.calcTicker.value = it.t;
        showTab("calculator");
        updateQuickLinks();
      };
      els.wlGrid.appendChild(card);
    });
  }

  async function fetchWatch(){
    for(const t of state.tickers){
      try{
        const g = await bridgePriceSeries(t);
        const rv = realizedVolFromSeries(g.series, 20);
        state.watch[t] = {
          current: g.current || null,
          rv20: rv || null,
          last: new Date().toISOString(),
          seriesLen: Array.isArray(g.series)? g.series.length : 0
        };
        if(!Array.isArray(g.series) || g.series.length===0){
          console.warn("Bridge returned no series for", t, g);
        }
      }catch(e){
        console.warn("bridge fail", t, e);
      }
    }
    saveAll(); renderWatchlist();
  }

  // ------------------ Calculator ------------------
  function updateQuickLinks(){
    const sym = (els.calcTicker.value||"").trim().toUpperCase();
    if(!sym) return;
    els.lkRobin.onclick = ()=> window.open(`https://robinhood.com/options/chains/${sym.toLowerCase()}/builder/short_put`,'_blank','noopener');
    els.lkAlpha.onclick  = ()=> window.open(`https://www.alphaspread.com/security/nyse/${sym}/summary`,'_blank','noopener');
    els.lkYahoo.onclick  = ()=> window.open(`https://finance.yahoo.com/quote/${sym}/options?type=puts`,'_blank','noopener');
  }

  function drawChart(series, S, K, BE){
    const ctx = els.calcChart.getContext("2d");
    ctx.clearRect(0,0,els.calcChart.width, els.calcChart.height);
    const W = els.calcChart.width, H = els.calcChart.height;
    // axes
    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue("--line");
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(40,10); ctx.lineTo(40,H-20); ctx.lineTo(W-10,H-20); ctx.stroke();
    if(!Array.isArray(series) || series.length===0) return;
    // scale
    const xs = series.map(r=>r[1]).filter(x=>isFinite(x));
    const min = Math.min(...xs.concat([K,BE,S]))*0.95;
    const max = Math.max(...xs.concat([K,BE,S]))*1.05;
    const x0 = 40, x1 = W-10, y0 = 10, y1 = H-20;
    function X(i){ return x0 + (i/(series.length-1))*(x1-x0); }
    function Y(p){ return y1 - ( (p-min)/(max-min) )*(y1-y0); }
    // series line
    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue("--blue");
    ctx.lineWidth = 2;
    ctx.beginPath();
    for(let i=0;i<series.length;i++){
      const x = X(i), y = Y(series[i][1]);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
    // lines: S, K, BE
    function hline(price, color){
      if(!isFinite(price)) return;
      ctx.strokeStyle = color; ctx.setLineDash([5,4]); ctx.beginPath();
      ctx.moveTo(x0, Y(price)); ctx.lineTo(x1, Y(price)); ctx.stroke();
      ctx.setLineDash([]);
    }
    hline(S, "#7c7cff");
    hline(K, "#f26d6d");
    hline(BE,"#6ddf86");
    // labels
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue("--muted");
    ctx.font = "12px -apple-system, system-ui, sans-serif";
    ctx.fillText("Start", x0-10, H-6);
    ctx.fillText("Expiry", x1-44, H-6);
  }

  async function runCalc(){
    const sym = (els.calcTicker.value||"").trim().toUpperCase();
    const K = +els.calcStrike.value || 0;
    const prem = +els.calcPremium.value || 0;
    const N = +els.calcContracts.value || 1;
    const fee = +els.calcFees.value || state.settings.fees;
    const slip = (+els.calcSlip.value || state.settings.slip)/100;
    if(!sym||!(K>0)||!(prem>0)) return alert("Enter Ticker, Strike, Premium");

    // price + series
    let S=null, series=null;
    try{
      const g = await bridgePriceSeries(sym);
      S = g.current || null;
      series = Array.isArray(g.series) ? g.series : null;
      if(!series || !series.length) console.warn("No series in calculator for", sym, g);
    }catch(e){ console.warn(e); }

    // realized vol (RV20)
    const rv = realizedVolFromSeries(series, 20);
    els.rvLabel.textContent = "RV20: " + (rv? fmt(rv): "‚Äî");

    // IV priority: manual ‚Üí RV
    let sigma = null;
    const manualIV = +els.calcManualIV.value;
    if(isFinite(manualIV) && manualIV>0) sigma = manualIV/100;
    else sigma = rv || 0.30;

    // expiry T (years)
    const exp = els.calcExpiry.value;
    const Td = (exp ? Math.max(1, Math.round((new Date(exp)-new Date())/86400000)) : 30);
    const T = Td/365;

    // adjusted premium after slippage (sell worse), and fees per contract
    const premNet = prem*(1 - slip) - fee;

    // KPIs
    const collateral = K*100*N;
    const BE = K - premNet;
    const monthlyYield = (premNet*100 / collateral) * (21/Math.max(1,Math.round(T*252))) * 100;
    const pop = popPut(S||K, K, sigma, T) || 0;

    els.kpiPrice.textContent = "Price: $" + fmt(S);
    els.kpiBreakeven.textContent = "BE: $" + fmt(BE);
    els.kpiYield.textContent = "Monthly %: " + fmt(monthlyYield) + "%";
    els.kpiPoP.textContent = "PoP: " + fmt(pop) + "%";
    els.kpiCollateral.textContent = "Collateral: $" + fmt(collateral);

    drawChart(series||[], S||null, K, BE);
  }

  // ------------------ Journal (Wheel) ------------------
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function mkBtn(label, on){ const b=document.createElement("button"); b.className="btn mini"; b.textContent=label; b.onclick=on; return b; }

  function renderJournal(){
    const legs = state.journal.trades||[];
    const cspClosed = legs.filter(l=>l.legType==="CSP" && l.outcome);
    const cspWins = cspClosed.filter(l=>l.outcome==="non_assignment").length;
    const cspAssign = cspClosed.filter(l=>l.outcome==="assigned").length;
    const cspWinrate = cspClosed.length? (100*cspWins/cspClosed.length): 0;
    document.getElementById("jrCspWin").textContent = "CSP Winrate: " + fmt(cspWinrate) + "%";
    document.getElementById("jrAssignRate").textContent = "Assignment: " + fmt(cspClosed.length? (100*cspAssign/cspClosed.length):0) + "%";

    const closedCycles = state.journal.cycles.filter(c=>c.closed);
    const totalCyclePnL = closedCycles.reduce((a,c)=> a + (c.cyclePnL||0),0);
    document.getElementById("jrCyclePnl").textContent = "Closed Cycle PnL: $" + fmt(totalCyclePnL);

    els.journalGrid.innerHTML = "";
    legs.slice().reverse().forEach(l=>{
      const card = document.createElement("div");
      card.className="card";
      const title = `${l.legType} ‚Ä¢ ${l.ticker} ‚Ä¢ ${l.strike ? ('$'+fmt(l.strike)):""} ‚Ä¢ ${l.expiry||""}`;
      const status = l.outcome? l.outcome.replace("_"," "): "open";
      card.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">${title}</h3>
          <span class="badge">${status}</span>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="pill">Premium: $${fmt(l.premium)} x ${l.contracts||1}</div>
          <div class="pill">Fees: $${fmt(l.fees||0)}</div>
          <div class="pill">Opened: ${l.openDate||""}</div>
        </div>
        <div class="row" style="margin-top:10px" data-actions></div>
      `;
      const actions = card.querySelector("[data-actions]");

      if(l.legType==="CSP"){
        const b1 = mkBtn("Mark Non-Assignment", ()=>{ l.outcome="non_assignment"; l.closeDate=todayISO(); saveAll(); renderJournal(); });
        const b2 = mkBtn("Mark Assigned", ()=>{ l.outcome="assigned"; l.closeDate=todayISO(); startCycleFromCSP(l); saveAll(); renderJournal(); });
        actions.append(b1,b2);
      } else if(l.legType==="CC"){
        const b1 = mkBtn("Mark Expired", ()=>{ l.outcome="expired"; l.closeDate=todayISO(); saveAll(); renderJournal(); });
        const b2 = mkBtn("Mark Called Away", ()=>{ l.outcome="called_away"; l.closeDate=todayISO(); closeCycleFromCC(l); saveAll(); renderJournal(); });
        actions.append(b1,b2);
      }

      els.journalGrid.appendChild(card);
    });
  }

  function startCycleFromCSP(csp){
    const shares = 100*(csp.contracts||1);
    const costBasis = (csp.strike - (csp.premium - (csp.fees||0))) || csp.strike;
    const cycle = {
      cycleId: uid(),
      ticker: csp.ticker,
      assignedFromCspId: csp.id,
      shares,
      assignedCostBasis: costBasis,
      ccLegIds: [],
      closed: false,
      calledAwayPrice: null,
      cyclePnL: 0
    };
    state.journal.cycles.push(cycle);
    saveAll();
    alert("Assignment recorded. You can now add CC legs for this cycle (Journal ‚Üí Add CC).");
  }

  function closeCycleFromCC(cc){
    const cyc = state.journal.cycles.find(c=>!c.closed && c.ticker===cc.ticker);
    if(!cyc){ alert("No open cycle found for "+cc.ticker); return; }
    cyc.calledAwayPrice = cc.strike;
    cyc.closed = true;
    const legs = state.journal.trades.filter(l=> l.ticker===cyc.ticker && (l.legType==="CSP" || l.legType==="CC"));
    let netPrem=0, fees=0;
    legs.forEach(l=>{ netPrem += (l.premium||0)*(l.contracts||1)*100; fees += (l.fees||0); });
    const shares = cyc.shares||100;
    const stockPnL = (cyc.calledAwayPrice - cyc.assignedCostBasis) * (shares/1);
    cyc.cyclePnL = netPrem + stockPnL - fees;
  }

  function addManualLeg(type){
    const t0 = (els.calcTicker.value||"").trim().toUpperCase();
    const t = prompt(type+" ticker (e.g., RIOT)", t0).toUpperCase().trim();
    if(!t) return;
    const strike = +prompt("Strike","")||0;
    const prem = +prompt("Premium (per share)","")||0;
    const con = +prompt("Contracts","1")||1;
    const exp = prompt("Expiry (YYYY-MM-DD)", nextFridayISO());
    const fees = +prompt("Fees total (optional)","0")||0;
    const leg = {
      id: uid(), legType:type, ticker:t,
      strike, premium:prem, contracts:con, expiry:exp,
      fees, slippage:0, openDate: todayISO(), outcome:null
    };
    state.journal.trades.push(leg);
    saveAll(); renderJournal();
  }

  // ------------------ Screener (demo) ------------------
  function runScreener(){
    const minPop = +els.scMinPop.value || 0;
    const minYield = +els.scMinYield.value || 0;
    const maxDte = +els.scMaxDte.value || 45;
    const items = state.tickers.map(t=>{
      const m = state.watch[t]||{};
      const price = m.current||0, strike = Math.round(price*0.95*100)/100;
      const prem = price? +(0.005*price).toFixed(2): 0;
      const slip = state.settings.slip/100, fee=state.settings.fees;
      const premNet = prem*(1-slip)-fee;
      const monthly = price? (premNet*100/(strike*100))*100 : 0;
      const sigma = m.rv20 || 0.3;
      const pop = popPut(price||strike, strike, sigma, Math.min(45,maxDte)/365) || 0;
      return { t, price, strike, prem, monthly, pop };
    }).filter(r=> r.pop>=minPop && r.monthly>=minYield);

    const sort = els.scSort.value;
    if(sort==="yieldAsc") items.sort((a,b)=> a.monthly-b.monthly);
    if(sort==="yieldDesc") items.sort((a,b)=> b.monthly-a.monthly);

    els.scGrid.innerHTML="";
    items.forEach(r=>{
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <h3 style="margin:0">${r.t}</h3>
        <div class="row" style="margin-top:6px">
          <div class="pill">Price $${fmt(r.price)}</div>
          <div class="pill">Strike $${fmt(r.strike)}</div>
          <div class="pill">Prem $${fmt(r.prem)}</div>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="pill">Monthly % ${fmt(r.monthly)}%</div>
          <div class="pill">PoP ${fmt(r.pop)}%</div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn mini" data-use="${r.t}">Use in Calculator</button>
        </div>`;
      card.querySelector("[data-use]").onclick=()=>{
        els.calcTicker.value=r.t; showTab("calculator"); updateQuickLinks();
        els.calcStrike.value=r.strike; els.calcPremium.value=r.prem;
      };
      els.scGrid.appendChild(card);
    });
  }

  // ------------------ Settings & Misc ------------------
  function applyMode(){
    if(els.execMode.value==="robinhood"){
      els.defFees.value = "0.04";
      els.defSlip.value = "0.00";
    }
  }
  function saveSettings(){
    state.settings.bridgeUrl = els.bridgeUrl.value.trim();
    state.settings.fees = +els.defFees.value || 0;
    state.settings.slip = +els.defSlip.value || 0;
    state.settings.mode = els.execMode.value;
    saveAll();
    alert("Saved.");
  }

  function exportJSON(){
    const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download="wheel_toolkit_v231.json"; a.click();
    URL.revokeObjectURL(url);
  }
  function importJSON(){
    const inp = document.createElement("input");
    inp.type="file"; inp.accept="application/json";
    inp.onchange = ()=> {
      const f = inp.files[0]; if(!f) return;
      const rd = new FileReader();
      rd.onload = ()=> {
        try{
          const s = JSON.parse(rd.result);
          if(s.settings) state.settings = Object.assign(state.settings, s.settings);
          if(Array.isArray(s.tickers)) state.tickers = s.tickers;
          if(s.watch) state.watch = s.watch;
          if(s.journal) state.journal = s.journal;
          saveAll(); initUI();
          alert("Imported.");
        }catch(e){ alert("Invalid JSON."); }
      };
      rd.readAsText(f);
    };
    inp.click();
  }

  function initUI(){
    // Prefill default bridge if empty (first run)
    if(!state.settings.bridgeUrl) state.settings.bridgeUrl = DEFAULT_BRIDGE;

    // settings
    els.bridgeUrl.value = state.settings.bridgeUrl||"";
    els.execMode.value = state.settings.mode||"custom";
    els.defFees.value = state.settings.fees;
    els.defSlip.value = state.settings.slip;

    // watchlist
    renderWatchlist();
    // journal
    renderJournal();
    // links
    updateQuickLinks();
  }

  // ------------------ Events ------------------
  document.addEventListener("DOMContentLoaded", ()=>{
    refs(); loadAll(); initUI();

    els.tabs.forEach(b=> b.onclick = ()=> showTab(b.dataset.tab));
    els.addBtn.onclick = ()=> {
      const t = (els.addTicker.value||"").trim().toUpperCase();
      if(t && !state.tickers.includes(t)){ state.tickers.push(t); saveAll(); renderWatchlist(); }
      els.addTicker.value="";
    };
    // Enter hotkey to add
    els.addTicker.addEventListener("keydown", (e)=>{ if(e.key==="Enter") els.addBtn.click(); });

    els.fetchBtn.onclick = fetchWatch;

    // Debug Bridge tester
    document.getElementById("debugBridgeBtn").onclick = async ()=>{
      const sym = (els.addTicker.value || state.tickers[0] || "RIOT").toUpperCase();
      try{
        const base = (state.settings.bridgeUrl||"").trim();
        if(!base) return alert("Set your Bridge URL in Settings.");
        const url = `${base}?ticker=${encodeURIComponent(sym)}`;
        const r = await fetch(url, { cache: "no-store" });
        const j = await r.json();
        console.log("[Bridge payload]", j);
        const sl = Array.isArray(j.series) ? j.series.length : 0;
        const tail = sl ? j.series.slice(-3).map(row=>row[0]).join(", ") : "(none)";
        alert(`Bridge OK for ${sym}\nseries.length = ${sl}\nlast dates: ${tail}\ncurrent: ${j.current}`);
      }catch(e){
        console.error("Debug Bridge error", e);
        alert("Bridge error: " + e);
      }
    };

    els.wlSort.onchange = renderWatchlist;
    els.wlMinIV.oninput = renderWatchlist;

    els.calcBtn.onclick = runCalc;
    els.saveCspBtn.onclick = ()=>{
      const t=(els.calcTicker.value||"").trim().toUpperCase();
      if(!t) return alert("Ticker required");
      const leg = {
        id: uid(), legType:"CSP", ticker:t,
        strike:+els.calcStrike.value||0, premium:+els.calcPremium.value||0,
        contracts:+els.calcContracts.value||1, expiry:els.calcExpiry.value,
        fees:+els.calcFees.value||0, slippage:+els.calcSlip.value||0,
        openDate: todayISO(), outcome:null
      };
      state.journal.trades.push(leg); saveAll(); renderJournal();
      alert("CSP leg saved to Journal.");
    };

    // links update whenever ticker changes
    els.calcTicker.addEventListener("input", updateQuickLinks);

    // screener
    els.scRun.onclick = runScreener;
    els.scSort.onchange = runScreener;

    // journal add
    els.addCspManual.onclick = ()=> addManualLeg("CSP");
    els.addCcManual.onclick  = ()=> addManualLeg("CC");

    // settings
    els.setDefaultBridge.onclick = ()=>{
      els.bridgeUrl.value = DEFAULT_BRIDGE;
      state.settings.bridgeUrl = DEFAULT_BRIDGE;
      saveAll();
      alert("Bridge URL set to default.");
    };
    els.execMode.onchange = applyMode;
    els.saveSettings.onclick = saveSettings;

    // header toggle (UI only)
    els.modeTitle.onclick = ()=>{
      els.modeTitle.textContent = (els.modeTitle.textContent.includes("CSP"))? "Quick CC Calculator" : "Quick CSP Calculator";
    };

    // dark toggle
    els.darkToggle.onclick = ()=> document.body.classList.toggle("dark");

    // help
    document.getElementById("helpBtn").onclick = ()=> document.getElementById("helpModal").style.display="flex";
    document.getElementById("helpClose").onclick = ()=> document.getElementById("helpModal").style.display="none";

    // export/import
    document.getElementById("exportBtn").onclick = exportJSON;
    document.getElementById("importBtn").onclick = importJSON;
  });
  </script>
</body>
</html>
